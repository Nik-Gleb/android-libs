package opengl;

import android.opengl.GLES11Ext;
import android.opengl.GLES20;

import java.io.Closeable;

import proguard.annotation.Keep;
import proguard.annotation.KeepPublicClassMembers;

/**
 * @author Nikitenko Gleb
 * @since 1.0, 14/12/2017
 */
public final class Texture2d implements Closeable {

  /** The tag of texture. */
  private final int mName;

  /** The target of the active texture unit to which the texture is bound. */
  private final int mTarget;

  /** "CLOSE" flag-state. */
  private volatile boolean mClosed;

  /**
   * Constructs a new {@link Texture2d}.
   *
   * @param external true for use EOS-External targets
   */
  public Texture2d(boolean external) {
    mTarget = !external ? GLES20.GL_TEXTURE_2D :
        GLES11Ext.GL_TEXTURE_EXTERNAL_OES;
    GLES20.glGenTextures(NUM, mValues, OFFSET);
    mName = mValues[OFFSET];
  }

  /** Make texture0 active.  */
  public void activeTexture0() {GLES20.glActiveTexture(GLES20.GL_TEXTURE0);}

  /** {@inheritDoc} */
  @Override public final void close() {
    if (mClosed) return;
    GLES20.glDeleteTextures(NUM, mValues, OFFSET);
    mClosed = true;
  }

  /** The tag of texture. */
  public final int getName() {return mName;}

  /** {@inheritDoc} */
  @Override protected final void finalize() throws Throwable
  {try {close();} finally {super.finalize();}}

  /** Bind this texture. */
  public final void bind() {GLES20.glBindTexture(mTarget, mName);}

  /** Unbind this texture. */
  public final void unbind() {GLES20.glBindTexture(mTarget, DEFAULT_NAME);}

  static final void saveTexture(int tag) {
    GLES20.glGetIntegerv(GLES20.GL_TEXTURE_BINDING_2D);
  }

  /** Initialize the texture. */
  public final void init() {
    GLES20.glTexParameterf(mTarget, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_NEAREST);
    GLES20.glTexParameterf(mTarget, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_LINEAR);
    GLES20.glTexParameteri(mTarget, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE);
    GLES20.glTexParameteri(mTarget, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE);
  }


  static final int[] createTexture(boolean external) {
    final int target = 0, texture = 1;
    final int[] result = new int[2];
    result[target] = !external ? GLES20.GL_TEXTURE_2D :
        GLES11Ext.GL_TEXTURE_EXTERNAL_OES;
    GLES20.glGenTextures(result.length, result, texture);
    return ;
  }
}
